# Deye Cloud 2 — інтеграція для Home Assistant

Кастомна інтеграція, що отримує телеметрію інвертора Deye безпосередньо з Deye Cloud API та публікує її як сенсори Home Assistant.

## Можливості
- **Пряме підключення до Deye Cloud API** з підтримкою серверів EU та US
- **Кешування токенів** - зменшення навантаження на API
- **Retry логіка** - автоматичні повторні спроби при помилках мережі
- **Валідація конфігурації** - перевірка облікових даних під час налаштування
- **Покращене логування** - детальні логи для діагностики проблем
- Хмарне опитування API (cloud_polling)
- Динамічне створення сенсорів на основі вхідних ключів (в т.ч. під час роботи)
- **Бінарні сенсори** - онлайн статус пристрою
- **Групування сенсорів** - організація по категоріях (PV, Grid, Battery, Load, Inverter, System)
- **Автоматичні іконки** - спеціальні іконки для різних типів даних
- UI-конфігурація (Config Flow): облікові дані, вибір сервера, інтервал опитування
- Автоматичне визначення `device_class` та `state_class` для сенсорів

## Вимоги
- Home Assistant 2024.6.0 або новіший
- Облікові дані Deye Cloud (App ID, App Secret, Email, Password, Device SN)

## Як отримати облікові дані Deye Cloud (App ID / App Secret)
1. Зареєструйте акаунт розробника:
   - Перейдіть: `https://developer.deyecloud.com/home`
   - Зареєструйтесь або увійдіть під своїми обліковими даними Deye Cloud
2. Створіть додаток:
   - Перейдіть: `https://developer.deyecloud.com/app`
   - Натисніть "Create App"
   - Отримаєте: App ID і App Secret — використовуйте їх у налаштуванні інтеграції
3. Оберіть правильний базовий URL за регіоном:
   - Європа (EU): `https://eu1-developer.deyecloud.com/v1.0`
   - США (US): `https://us1-developer.deyecloud.com/v1.0`

## Встановлення через HACS (рекомендовано)
1. У HACS додайте цей репозиторій як кастомний (Custom repositories) з типом "Integration".
2. Встановіть "Deye Cloud 2" у HACS.
3. Перезапустіть Home Assistant.
4. Додайте інтеграцію через: Налаштування → Пристрої й служби → Додати інтеграцію → "Deye Cloud 2".

> Після кожного оновлення інтеграцій (custom_components) обов'язково перезапускайте Home Assistant.

## Ручне встановлення
1. Скопіюйте папку `custom_components/deyecloud2` у каталог `config/custom_components/` вашого Home Assistant.
2. Перезапустіть Home Assistant і додайте інтеграцію через UI, як описано вище.

## Налаштування
Під час додавання інтеграції через UI вкажіть:
- **App ID** — ідентифікатор додатку Deye Cloud
- **App Secret** — секретний ключ додатку Deye Cloud  
- **Email** — email облікового запису Deye Cloud
- **Password** — пароль облікового запису Deye Cloud
- **Device SN** — серійний номер пристрою (інвертора)
- **Сервер** — вибір між Europe (EU1) та United States (US1)
- **Інтервал опитування** — у секундах (типово 60)

> **Безпека**: Облікові дані зберігаються зашифрованими в конфігурації Home Assistant. Не передавайте їх третім особам.

## Як це працює
- Інтеграція авторизується в Deye Cloud API за допомогою ваших облікових даних
- **Токени кешуються** на 1 годину для зменшення навантаження на API
- Отримує останні дані пристрою через API:
  - **EU сервер**: `https://eu1-developer.deyecloud.com/v1.0/device/latest`
  - **US сервер**: `https://us1-developer.deyecloud.com/v1.0/device/latest`
- **Retry логіка** автоматично повторює невдалі запити (до 3 спроб)
- Конвертує відповідь API у внутрішній формат сенсорів
- Ключі сенсорів нормалізуються (нижній регістр, заміна пробілів/символів на `_`)
- **Автоматичні іконки** призначаються на основі типу сенсора
- **Групування** сенсорів по категоріях для кращої організації
- Нові ключі, що з'являються у відповіді згодом, автоматично створюють нові сенсори

## Відомі обмеження
- Для енергетичних лічильників (`kWh`) встановлено `state_class: total_increasing` — переконайтеся, що ваш API не скидає значення без попередження
- Інтеграція залежить від стабільності API Deye Cloud та валідності ваших облікових даних
- Якщо Device SN не відповідає вашому інвертору, сенсори не будуть створені

## Релізи та версіонування
- Версія інтеграції вказується у `custom_components/deyecloud2/manifest.json` (`version`)
- Для коректної роботи з HACS публікуйте теги Git (`v0.2.0`, `v0.2.1`, …) і релізи GitHub
- Файл `hacs.json` містить мінімальні вимоги (`homeassistant`) і вказівку рендерити README у HACS

## Усунення проблем
- **Валідація конфігурації**: інтеграція автоматично перевіряє облікові дані під час налаштування
- Переконайтеся у валідності облікових даних та перегляньте Журнали на помилки авторизації
- **Retry логіка**: інтеграція автоматично повторює невдалі запити, перевірте логи на деталі
- Збільште інтервал опитування, якщо API має обмеження частоти
- Перевірте, що Device SN відповідає вашому інвертору в Deye Cloud
- Спробуйте змінити сервер (EU/US), якщо виникають проблеми з підключенням
- **Кешування токенів**: токени зберігаються на 1 годину, при проблемах з авторизацією перезапустіть інтеграцію

## Структура
- Маніфест: `custom_components/deyecloud2/manifest.json`
- Координатор/Парсер: `custom_components/deyecloud2/__init__.py`
- Сенсори: `custom_components/deyecloud2/sensor.py`
- Бінарні сенсори: `custom_components/deyecloud2/binary_sensor.py`
- Конфіг-флоу (UI): `custom_components/deyecloud2/config_flow.py`
- Переклади: `custom_components/deyecloud2/translations/`
- Іконка: `custom_components/deyecloud2/icon.svg`
- HACS метадані: `hacs.json`

## Ліцензія
MIT (замініть за потреби).
